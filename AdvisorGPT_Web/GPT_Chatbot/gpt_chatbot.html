<!-- GPT_Chatbot/gpt_chatbot.html 의 <script> 태그 내부 수정 -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdvisorGPT 챗봇</title>
    <link rel="stylesheet" href="../Main_Page/style.css"> <!-- 기본 스타일 상속 -->
    <link rel="stylesheet" href="style_chatbot.css"> <!-- 챗봇 페이지 전용 스타일 -->
    <link href="https://fonts.googleapis.com/css2?family=Mulish&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="main-dashboard-container">
        <!-- Left Sidebar -->
        <aside class="sidebar left-sidebar">
            <div class="profile-section">
                <img src="../image/user_profile_default.png" alt="User Profile" class="profile-pic">
                <p class="user-nickname" id="sidebar-username">User</p>
            </div>
            <nav class="menu-section">
                <ul id="sidebar-menu">
                    <li><a href="../Main_Page/main.html"><img src="../image/icon_my_today.png" alt="" class="menu-icon"> 나의 오늘</a></li>
                    <li><a href="../Health_Report/health_report.html"><img src="../image/icon_health_report.png" alt="" class="menu-icon"> 건강 리포트</a></li>
                    <li class="active"><a href="../GPT_Chatbot/gpt_chatbot.html"><img src="../image/icon_gpt_chatbot.png" alt="" class="menu-icon"> GPT Chatbot</a></li>
                    <li><a href="../Settings_Page/settings.html"><img src="../image/icon_settings.png" alt="" class="menu-icon"> 설정</a></li>
                </ul>
            </nav>
            <div class="logo-section">
                <img src="../image/AdvisorGPT_Logo_big.png" alt="AdvisorGPT Logo" class="advisor-logo">
            </div>
        </aside>

        <!-- Main Content for Chatbot -->
        <main class="main-content chatbot-page-container">
            <div class="chatbot-interface">
                <div class="chat-display-area" id="chat-display">
                    <div class="chat-initial-logo-container">
                        <img src="../image/AdvisorGPT_Logo_big.png" alt="AdvisorGPT Initial Logo" class="chat-initial-logo">
                    </div>
                    <div class="chat-message gpt">
                        <img src="../image/chatbot_avatar.png" alt="GPT Avatar" class="chat-avatar">
                        <div class="message-bubble">
                            <p>안녕하세요! AdvisorGPT입니다. 무엇을 도와드릴까요? 건강 관련 질문이나 고민을 말씀해주세요.</p>
                        </div>
                    </div>
                </div>
                <div class="chat-input-wrapper">
                    <div class="chat-input-area">
                        <textarea id="chat-message-input" placeholder="메시지를 입력하세요..." rows="1"></textarea>
                        <button id="send-message-button" class="send-button">
                            <img src="../image/icon_send_message.png" alt="Send">
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 기존 챗봇 페이지 JS 코드 시작 ---
    const chatDisplay = document.getElementById('chat-display');
    const messageInput = document.getElementById('chat-message-input');
    const sendButton = document.getElementById('send-message-button');
    const initialLogoContainer = document.querySelector('.chat-initial-logo-container');
    let isFirstUserMessage = true;
    // --- 기존 챗봇 페이지 JS 코드 끝 ---

    // --- 로그인한 사용자 정보 로드 및 사이드바 UI 업데이트 ---
    const loggedInUserEmail = localStorage.getItem('loggedInUserEmail');
    const sidebarProfilePic = document.getElementById('sidebar-profile-pic'); // HTML에 id="sidebar-profile-pic" 추가 필요
    const sidebarUsername = document.getElementById('sidebar-username'); // HTML에 id="sidebar-username"은 이미 있음
    const defaultProfilePicPath = '../image/user_profile_default.png';

    if (loggedInUserEmail) {
        const nickname = localStorage.getItem('userNickname') || 'User';
        // 사용자별 프로필 이미지를 가져오거나, 없으면 전체 프로필 이미지, 그것도 없으면 기본 이미지
        const userSpecificProfileKey = 'userProfileImage_' + loggedInUserEmail;
        const profilePic = localStorage.getItem(userSpecificProfileKey) || localStorage.getItem('userProfileImage') || defaultProfilePicPath;

        if (sidebarProfilePic) {
            sidebarProfilePic.src = profilePic;
            sidebarProfilePic.alt = nickname + " 프로필";
        }
        if (sidebarUsername) {
            sidebarUsername.textContent = nickname;
        }
    } else {
        // 로그인하지 않은 사용자를 위한 기본값 설정 또는 로그인 페이지로 리디렉션
        if (sidebarProfilePic) sidebarProfilePic.src = defaultProfilePicPath;
        if (sidebarUsername) sidebarUsername.textContent = 'User';
        // console.log("로그인 정보 없음, 기본 프로필 표시");
        // alert("로그인이 필요한 서비스입니다.");
        // window.location.href = '../Advisor_login/index.html';
    }

    // --- 사이드바 활성 메뉴 설정 ---
    // (기존 챗봇 페이지의 사이드바 활성 메뉴 로직은 그대로 유지)
    const currentChatbotPath = "gpt_chatbot.html";
    const sidebarLinks = document.querySelectorAll('#sidebar-menu li a');
    sidebarLinks.forEach(link => {
        link.parentElement.classList.remove('active');
    });
    const chatbotLink = Array.from(sidebarLinks).find(a => {
        const linkHref = a.getAttribute('href');
        const iconSrc = a.parentElement.querySelector('.menu-icon') ? a.parentElement.querySelector('.menu-icon').src : '';
        return (linkHref && linkHref.includes(currentChatbotPath)) ||
               (linkHref === "../GPT_Chatbot/gpt_chatbot.html") || // 직접 비교
                (linkHref === "#" && iconSrc.includes('icon_gpt_chatbot'));
    });
    if (chatbotLink) {
        chatbotLink.parentElement.classList.add('active');
    } else { // Fallback for stricter matching
        document.querySelector('#sidebar-menu li a[href*="gpt_chatbot.html"]')?.parentElement.classList.add('active');
    }


    // --- 기존 챗봇 페이지 JS 코드 (이벤트 리스너, 함수 등) ---
    // Auto-resize textarea (이전과 동일)
    messageInput.addEventListener('input', function() { /* ... */ });
    // Send Message Function (이전과 동일)
    async function sendMessage() { /* ... */ }
    // Append message to chat display (이전과 동일)
    function appendMessage(text, sender, isError = false) { /* ... */ }
    // Typing Indicator (이전과 동일)
    function appendTypingIndicator() { /* ... */ }
    function removeTypingIndicator() { /* ... */ }
    // Get GPT Response (Placeholder - 이전과 동일)
    async function getGptResponse(userMessage) { /* ... */ }
    // Event Listeners (이전과 동일)
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', function(event) { /* ... */ });
    if(chatDisplay) chatDisplay.scrollTop = chatDisplay.scrollHeight; 
});
</script>
