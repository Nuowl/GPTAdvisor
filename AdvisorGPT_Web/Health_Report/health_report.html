<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdvisorGPT</title>
    <link rel="stylesheet" href="../Main_Page/style.css"> <!-- 기본 스타일 상속 -->
    <link rel="stylesheet" href="style_report.css"> <!-- 리포트 페이지 전용 스타일 -->
    <link href="https://fonts.googleapis.com/css2?family=Mulish&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="main-dashboard-container">
        <!-- Left Sidebar -->
        <aside class="sidebar left-sidebar">
            <div class="profile-section">
                <img src="../image/user_profile_default.png" alt="User Profile" class="profile-pic" id="sidebar-profile-pic">
                <p class="user-nickname" id="sidebar-username">User</p>
            </div>
            <nav class="menu-section">
                <ul id="sidebar-menu">
                    <li><a href="../Main_Page/main.html"><img src="../image/icon_my_today.png" alt="" class="menu-icon"> 나의 오늘</a></li>
                    <li class="active"><a href="../Health_Report/health_report.html"><img src="../image/icon_health_report.png" alt="" class="menu-icon"> 건강 리포트</a></li>
                    <li><a href="../GPT_Chatbot/gpt_chatbot.html"><img src="../image/icon_gpt_chatbot.png" alt="" class="menu-icon"> GPT Chatbot</a></li>
                    <li><a href="../Settings_Page/settings.html"><img src="../image/icon_settings.png" alt="" class="menu-icon"> 설정</a></li>
                </ul>
            </nav>
            <div class="logo-section">  
                <img src="../image/AdvisorGPT_Logo_big.png" alt="AdvisorGPT Logo" class="advisor-logo">
            </div>
        </aside>

        <!-- Main Content for Health Report -->
        <main class="main-content report-content">
            <section class="goal-status-section">
                <p class="goal-text">
                    나의 목표 점수 
                    <input type="number" id="goal-score-input" min="1" max="100">점까지 
                    <span id="points-remaining">XX</span>점 남았습니다.
                </p>
                <p class="gpt-comment">GPT 격려 코멘트: 목표를 향해 꾸준히 나아가세요! 작은 변화가 큰 결과를 만듭니다.</p>
            </section>

            <section class="weekly-chart-section">
                <h2>주간 건강 점수</h2>
                <div class="chart-container">
                    <canvas id="weeklyHealthChart"></canvas>
                </div>
            </section>

            <section class="weekly-summary-section">
                <h2>주간 요약</h2>
                <ul class="summary-list" id="weekly-summary-list">
                    <!-- 요약 내용은 JS로 동적으로 채울 수 있으나, 초기 구조는 유지 -->
                    <li>
                        <img src="../image/icon_sleep_moon_right.png" alt="수면" class="summary-icon">
                        <span data-summary-type="sleep">지난 주 대비 수면 변화를 분석 중입니다...</span>
                    </li>
                    <li>
                        <img src="../image/icon_meal_bowl_center.png" alt="식사량" class="summary-icon">
                        <span data-summary-type="meal">지난 주 대비 식사량 변화를 분석 중입니다...</span>
                    </li>
                    <li>
                        <img src="../image/icon_exercise_dumbbell_center.png" alt="운동 시간" class="summary-icon">
                        <span data-summary-type="exercise">지난 주 대비 운동 시간 변화를 분석 중입니다...</span>
                    </li>
                    <li>
                        <img src="../image/icon_stress_head_center.png" alt="스트레스 지수" class="summary-icon">
                        <span data-summary-type="stress">지난 주 대비 스트레스 지수 변화를 분석 중입니다...</span>
                    </li>
                    <li>
                        <img src="../image/icon_health_score.png" alt="건강 점수" class="summary-icon"> <!-- icon_health_report.png 등으로 변경 가능 -->
                        <span data-summary-type="overall">지난 주 대비 전체 건강 점수 변화를 분석 중입니다...</span>
                    </li>
                </ul>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loggedInUserEmail = localStorage.getItem('loggedInUserEmail');
    const sidebarProfilePic = document.getElementById('sidebar-profile-pic');
    const sidebarUsername = document.getElementById('sidebar-username');
    const goalInput = document.getElementById('goal-score-input');
    const pointsRemainingSpan = document.getElementById('points-remaining');
    
    const defaultProfilePicPath = '../image/user_profile_default.png';
    const defaultGoalScore = 70; // 기본 목표 점수

    // --- 로그인한 사용자 정보 로드 및 사이드바/목표점수 UI 업데이트 ---
    if (loggedInUserEmail) {
        const nickname = localStorage.getItem('userNickname') || 'User';
        const userSpecificProfileKey = 'userProfileImage_' + loggedInUserEmail;
        // localStorage의 userProfileImage는 다른 페이지에서 공용으로 쓰는 현재 로그인 유저의 프로필 사진
        const profilePic = localStorage.getItem(userSpecificProfileKey) || localStorage.getItem('userProfileImage') || defaultProfilePicPath;

        if (sidebarProfilePic) {
            sidebarProfilePic.src = profilePic;
            sidebarProfilePic.alt = nickname + " 프로필";
        }
        if (sidebarUsername) {
            sidebarUsername.textContent = nickname;
        }

        const userGoalScoreKey = 'userGoalScore_' + loggedInUserEmail;
        const storedGoalScore = localStorage.getItem(userGoalScoreKey);
        goalInput.value = storedGoalScore ? parseInt(storedGoalScore) : defaultGoalScore;
    } else {
        // 로그인하지 않은 사용자 처리
        if (sidebarProfilePic) sidebarProfilePic.src = defaultProfilePicPath;
        if (sidebarUsername) sidebarUsername.textContent = 'User';
        goalInput.value = defaultGoalScore;
        // 일부 기능 제한 또는 로그인 페이지로 리디렉션 경고 등
        // 예: document.body.classList.add('機能制限');
    }

    // --- 주간 건강 점수 데이터 (실제로는 이 데이터를 동적으로 가져와야 함) ---
    const labels = ['월', '화', '수', '목', '금', '토', '일'];
    let weeklyScores = []; // 실제 사용자 데이터를 저장할 배열

    // TODO: 로그인한 사용자의 실제 주간 점수 데이터를 localStorage 또는 다른 곳에서 가져오는 로직 추가
    // 예시:
    // if (loggedInUserEmail) {
    //     const userWeeklyScoresKey = 'userWeeklyScores_' + loggedInUserEmail; // 사용자별 데이터 키
    //     const storedData = JSON.parse(localStorage.getItem(userWeeklyScoresKey));
    //     if (storedData && Array.isArray(storedData) && storedData.length === 7) {
    //         weeklyScores = storedData;
    //     } else {
    //         weeklyScores = [null, null, null, null, null, null, null]; // 데이터 없을 시
    //     }
    // } else {
    //     weeklyScores = [null, null, null, null, null, null, null]; // 비로그인 시
    // }
    // 임시 샘플 데이터 (실제 데이터 로드 로직으로 대체 필요)
    weeklyScores = [68, 72, 70, 78, 75, 80, 77]; // 차트가 보이도록 임시 데이터 유지


    const validScores = weeklyScores.filter(score => typeof score === 'number');
    const averageWeeklyScore = validScores.length > 0
        ? validScores.reduce((sum, score) => sum + score, 0) / validScores.length
        : 0;

    function updatePointsRemaining() {
        const currentGoalScore = parseInt(goalInput.value) || defaultGoalScore;
        // 입력값이 범위 벗어나면 조정
        goalInput.value = Math.max(1, Math.min(100, currentGoalScore)); 
        
        const remaining = Math.max(0, (parseInt(goalInput.value)) - Math.round(averageWeeklyScore));
        pointsRemainingSpan.textContent = remaining;
    }

    goalInput.addEventListener('input', updatePointsRemaining);
    goalInput.addEventListener('change', function() {
        updatePointsRemaining();
        if (loggedInUserEmail) {
            const userGoalScoreKey = 'userGoalScore_' + loggedInUserEmail;
            localStorage.setItem(userGoalScoreKey, goalInput.value);
        }
    });

    updatePointsRemaining(); // 초기 계산

    // --- Chart.js 설정 ---
    const ctx = document.getElementById('weeklyHealthChart');
    let weeklyHealthChartInstance = null; // 차트 인스턴스 저장 변수

    if (ctx) {
        weeklyHealthChartInstance = new Chart(ctx.getContext('2d'), { // 인스턴스 할당
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '주간 건강 점수',
                    data: weeklyScores,
                    borderColor: '#3377DD',
                    backgroundColor: 'rgba(51, 119, 221, 0.1)',
                    tension: 0.1,
                    fill: true,
                    pointBackgroundColor: '#3377DD',
                    pointBorderColor: '#FFFFFF',
                    pointHoverBackgroundColor: '#FFFFFF',
                    pointHoverBorderColor: '#3377DD',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100, min: 0, ticks: { stepSize: 10, color: '#555', font: { family: "'Noto Sans KR', sans-serif" } }, grid: { color: '#E0E0E0', drawBorder: false, } },
                    x: { ticks: { color: '#555', font: { family: "'Noto Sans KR', sans-serif" } }, grid: { display: true, drawBorder: false } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.7)', titleFont: { family: "'Noto Sans KR', sans-serif", size: 14 },
                        bodyFont: { family: "'Noto Sans KR', sans-serif", size: 12 }, padding: 10, cornerRadius: 6, displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y !== null ? `점수: ${context.parsed.y}` : '기록 없음';
                            }
                        }
                    }
                }
            }
        });
    } else {
        console.error("Error: Canvas element #weeklyHealthChart not found.");
    }

    // --- 주간 요약 업데이트 (샘플 로직, 실제 데이터 기반으로 수정 필요) ---
    function updateWeeklySummary() {
        const summaryList = document.getElementById('weekly-summary-list');
        if (!summaryList) return;

        // TODO: 실제 지난 주 데이터와 이번 주 평균 데이터를 비교하는 로직 필요
        // 아래는 하드코딩된 예시입니다.
        const summaryData = {
            sleep: { current: 7.2, change: -5, unit: "시간" }, // 5% 감소
            meal: { current: 1850, change: 3, unit: "kcal" },  // 3% 증가
            exercise: { current: 1.5, change: 10, unit: "시간" },// 10% 증가
            stress: { current: 65, change: -8, unit: "점" },   // 8% 감소 (긍정적)
            overall: { current: 78, change: 4, unit: "점" }    // 4% 증가
        };

        summaryList.querySelectorAll('li span[data-summary-type]').forEach(span => {
            const type = span.dataset.summaryType;
            const data = summaryData[type];
            if (data) {
                let changeText = "";
                if (data.change > 0) {
                    changeText = `<strong class="highlight-green">${Math.abs(data.change)}% 증가</strong>`;
                } else if (data.change < 0) {
                    changeText = `<strong class="highlight-red">${Math.abs(data.change)}% 감소</strong>`;
                } else {
                    changeText = "변동 없음";
                }
                let baseText = `이번 주 평균 ${
                    type === 'sleep' ? '수면 시간은' :
                    type === 'meal' ? '식사량은' :
                    type === 'exercise' ? '운동 시간은' :
                    type === 'stress' ? '스트레스 지수는' :
                    '건강 점수는'
                } <strong class="highlight-blue">${data.current}${data.unit}</strong>으로 지난 주 대비 ${changeText}했습니다.`;
                if (type === 'stress') baseText += " (점수가 낮을수록 긍정적입니다.)";
                if (type === 'overall' && data.change > 0) baseText += "!";
                
                span.innerHTML = baseText;
            }
        });
    }
    updateWeeklySummary();


    // --- 사이드바 활성 메뉴 설정 ---
    const currentReportPath = "health_report.html";
    const sidebarLinks = document.querySelectorAll('#sidebar-menu li a');
    sidebarLinks.forEach(link => { link.parentElement.classList.remove('active'); });
    const healthReportLinkFromList = Array.from(sidebarLinks).find(a => {
        const linkHref = a.getAttribute('href');
        const iconSrc = a.parentElement.querySelector('.menu-icon') ? a.parentElement.querySelector('.menu-icon').src : '';
        return (linkHref && linkHref.includes(currentReportPath)) ||
                (linkHref === "../Health_Report/health_report.html") ||
                (linkHref === "#" && iconSrc.includes('icon_health_report'));
    });
    if (healthReportLinkFromList) { healthReportLinkFromList.parentElement.classList.add('active');
    } else { document.querySelector('#sidebar-menu li a[href*="health_report.html"]')?.parentElement.classList.add('active'); }

});
</script>
</body>
</html>
