<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdvisorGPT 건강 리포트</title>
    <link rel="stylesheet" href="../Main_Page/style.css"> <!-- 기본 스타일 상속 -->
    <link rel="stylesheet" href="style_report.css"> <!-- 리포트 페이지 전용 스타일 -->
    <link href="https://fonts.googleapis.com/css2?family=Mulish&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="main-dashboard-container">
        <!-- Left Sidebar -->
        <aside class="sidebar left-sidebar">
            <div class="profile-section">
                <img src="../image/user_profile_default.png" alt="User Profile" class="profile-pic" id="sidebar-profile-pic">
                <p class="user-nickname" id="sidebar-username">User</p>
            </div>
            <nav class="menu-section">
                <ul id="sidebar-menu">
                    <li><a href="../Main_Page/main.html"><img src="../image/icon_my_today.png" alt="" class="menu-icon"> 나의 오늘</a></li>
                    <li class="active"><a href="../Health_Report/health_report.html"><img src="../image/icon_health_report.png" alt="" class="menu-icon"> 건강 리포트</a></li>
                    <li><a href="../GPT_Chatbot/gpt_chatbot.html"><img src="../image/icon_gpt_chatbot.png" alt="" class="menu-icon"> GPT Chatbot</a></li>
                    <li><a href="../Settings_Page/settings.html"><img src="../image/icon_settings.png" alt="" class="menu-icon"> 설정</a></li>
                </ul>
            </nav>
            <div class="logo-section">  
                <img src="../image/AdvisorGPT_Logo_big.png" alt="AdvisorGPT Logo" class="advisor-logo">
            </div>
        </aside>

        <!-- Main Content for Health Report -->
        <main class="main-content report-content">
            <section class="goal-status-section">
                <p class="goal-text">
                    나의 목표 점수 
                    <input type="number" id="goal-score-input" min="1" max="100" value="90">점까지 
                    <span id="points-remaining">XX</span>점 남았습니다.
                </p>
                <p class="gpt-comment">GPT 격려 코멘트: 목표를 향해 꾸준히 나아가세요! 작은 변화가 큰 결과를 만듭니다.</p>
            </section>

            <section class="weekly-chart-section">
                <h2>주간 건강 점수</h2>
                <div class="chart-container">
                    <canvas id="weeklyHealthChart"></canvas>
                </div>
            </section>

            <section class="weekly-summary-section">
                <h2>주간 요약</h2>
                <ul class="summary-list">
                    <li>
                        <img src="../image/icon_sleep_moon_right.png" alt="수면" class="summary-icon">
                        <span>이번 주 평균 수면 시간은 <strong class="highlight-blue">7.2시간</strong>으로 지난 주 대비 <strong class="highlight-red">5% 감소</strong>했습니다.</span>
                    </li>
                    <li>
                        <img src="../image/icon_meal_bowl_center.png" alt="식사량" class="summary-icon">
                        <span>이번 주 평균 식사량은 <strong class="highlight-blue">1850kcal</strong>으로 지난 주 대비 <strong class="highlight-green">3% 증가</strong>했습니다.</span>
                    </li>
                    <li>
                        <img src="../image/icon_exercise_dumbbell_center.png" alt="운동 시간" class="summary-icon">
                        <span>이번 주 평균 운동 시간은 <strong class="highlight-blue">1.5시간</strong>으로 지난 주 대비 <strong class="highlight-green">10% 증가</strong>했습니다.</span>
                    </li>
                    <li>
                        <img src="../image/icon_stress_head_center.png" alt="스트레스 지수" class="summary-icon">
                        <span>이번 주 평균 스트레스 지수는 <strong class="highlight-blue">65점</strong>으로 지난 주 대비 <strong class="highlight-green                                                         ">8% 감소</strong>했습니다. (점수가 낮을수록 긍정적입니다.)</span>
                    </li>
                    <li>
                        <img src="../image/icon_health_score.png" alt="건강 점수" class="summary-icon">
                        <span>이번 주 평균 건강 점수는 <strong class="highlight-blue">78점</strong>으로 지난 주 대비 <strong class="highlight-green">4% 증가</strong>했습니다!</span>
                    </li>
                </ul>
            </section>
        </main>
    </div>

<!-- Health_Report/health_report.html 의 <script> 태그 내부 수정 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loggedInUserEmail = localStorage.getItem('loggedInUserEmail');
    const sidebarProfilePic = document.getElementById('sidebar-profile-pic'); // HTML에 id 추가 필요
    const sidebarUsername = document.getElementById('sidebar-username'); // HTML에 id 이미 있음
    const defaultProfilePicPath = '../image/user_profile_default.png';
    const goalInput = document.getElementById('goal-score-input');
    const pointsRemainingSpan = document.getElementById('points-remaining');
    const defaultGoalScore = 70; // 기본 목표 점수

    // --- 로그인한 사용자 정보 로드 및 사이드바 UI 업데이트 ---
    if (loggedInUserEmail) {
        const nickname = localStorage.getItem('userNickname') || 'User';
        const userSpecificProfileKey = 'userProfileImage_' + loggedInUserEmail;
        const profilePic = localStorage.getItem(userSpecificProfileKey) || localStorage.getItem('userProfileImage') || defaultProfilePicPath;

        if (sidebarProfilePic) {
            sidebarProfilePic.src = profilePic;
            sidebarProfilePic.alt = nickname + " 프로필";
        }
        if (sidebarUsername) {
            sidebarUsername.textContent = nickname;
        }

        // --- 목표 점수 로드 및 설정 ---
        const userGoalScoreKey = 'userGoalScore_' + loggedInUserEmail;
        const storedGoalScore = localStorage.getItem(userGoalScoreKey);
        goalInput.value = storedGoalScore ? parseInt(storedGoalScore) : defaultGoalScore;

    } else {
        // 로그인하지 않은 사용자 처리
        if (sidebarProfilePic) sidebarProfilePic.src = defaultProfilePicPath;
        if (sidebarUsername) sidebarUsername.textContent = 'User';
        goalInput.value = defaultGoalScore; // 로그인 안 했어도 기본 목표 점수 표시
        // alert("로그인이 필요한 서비스입니다. 일부 기능이 제한될 수 있습니다.");
        // window.location.href = '../Advisor_login/index.html'; // 필요시 리디렉션
    }


    // --- 기존 건강 리포트 페이지 JS 코드 시작 ---
    const weeklyScores = [68, 72, 70, 78, 75, 80, 77]; // 샘플 데이터
    const labels = ['월', '화', '수', '목', '금', '토', '일'];
    const averageWeeklyScore = weeklyScores.reduce((sum, score) => sum + score, 0) / weeklyScores.length;
    // --- 기존 건강 리포트 페이지 JS 코드 끝 ---


    function updatePointsRemaining() {
        const currentGoalScore = parseInt(goalInput.value) || defaultGoalScore; // 입력값이 없거나 잘못되면 기본값 사용
        if (currentGoalScore < 1) goalInput.value = 1;
        if (currentGoalScore > 100) goalInput.value = 100;
        
        const remaining = Math.max(0, (parseInt(goalInput.value) || defaultGoalScore) - Math.round(averageWeeklyScore));
        pointsRemainingSpan.textContent = remaining;
    }

    goalInput.addEventListener('input', updatePointsRemaining);
    goalInput.addEventListener('change', function() { // 목표 점수 변경 시 저장
        updatePointsRemaining();
        if (loggedInUserEmail) {
            const userGoalScoreKey = 'userGoalScore_' + loggedInUserEmail;
            localStorage.setItem(userGoalScoreKey, goalInput.value);
            // alert("목표 점수가 저장되었습니다."); // 사용자에게 알림 (선택 사항)
        }
    });

    updatePointsRemaining(); // 초기 계산

    // --- Chart.js 설정 (이전과 동일) ---
    const ctx = document.getElementById('weeklyHealthChart').getContext('2d');
    const weeklyHealthChart = new Chart(ctx, { /* ... 차트 설정 ... */ });

    // --- 사이드바 활성 메뉴 설정 (이전과 동일) ---
    const currentReportPath = "health_report.html";
    const sidebarLinks = document.querySelectorAll('#sidebar-menu li a');
    sidebarLinks.forEach(link => { /* ... */ });
    // ... (이하 활성 메뉴 로직은 이전 답변과 동일하게 유지)
    sidebarLinks.forEach(link => {
        link.parentElement.classList.remove('active');
    });
    const healthReportLinkFromList = Array.from(sidebarLinks).find(a => {
        const linkHref = a.getAttribute('href');
        const iconSrc = a.parentElement.querySelector('.menu-icon') ? a.parentElement.querySelector('.menu-icon').src : '';
        return (linkHref && linkHref.includes(currentReportPath)) ||
                (linkHref === "../Health_Report/health_report.html") ||
                (linkHref === "#" && iconSrc.includes('icon_health_report'));
    });
    if (healthReportLinkFromList) {
        healthReportLinkFromList.parentElement.classList.add('active');
    } else {
        document.querySelector('#sidebar-menu li a[href*="health_report.html"]')?.parentElement.classList.add('active');
    }
});
</script>
</body>
</html>
