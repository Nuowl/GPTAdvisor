<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdvisorGPT</title>
    <link rel="stylesheet" href="../Main_Page/style.css"> <!-- 기본 스타일 상속 -->
    <link rel="stylesheet" href="style_report.css"> <!-- 리포트 페이지 전용 스타일 -->
    <link href="https://fonts.googleapis.com/css2?family=Mulish&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="main-dashboard-container">
        <!-- Left Sidebar -->
        <aside class="sidebar left-sidebar">
            <div class="profile-section">
                <img src="../image/user_profile_default.png" alt="User Profile" class="profile-pic" id="sidebar-profile-pic">
                <p class="user-nickname" id="sidebar-username">User</p>
            </div>
            <nav class="menu-section">
                <ul id="sidebar-menu">
                    <li><a href="../Main_Page/main.html"><img src="../image/icon_my_today.png" alt="" class="menu-icon"> 나의 오늘</a></li>
                    <li class="active"><a href="../Health_Report/health_report.html"><img src="../image/icon_health_report.png" alt="" class="menu-icon"> 건강 리포트</a></li>
                    <li><a href="../GPT_Chatbot/gpt_chatbot.html"><img src="../image/icon_gpt_chatbot.png" alt="" class="menu-icon"> GPT Chatbot</a></li>
                    <li><a href="../Settings_Page/settings.html"><img src="../image/icon_settings.png" alt="" class="menu-icon"> 설정</a></li>
                </ul>
            </nav>
            <div class="logo-section">  
                <img src="../image/AdvisorGPT_Logo_big.png" alt="AdvisorGPT Logo" class="advisor-logo">
            </div>
        </aside>

        <!-- Main Content for Health Report -->
        <main class="main-content report-content">
            <section class="goal-status-section">
                <p class="goal-text">
                    나의 목표 점수 
                    <input type="number" id="goal-score-input" min="1" max="100">점까지 
                    <span id="points-remaining">XX</span>점 남았습니다.
                </p>
                <p class="gpt-comment">GPT 격려 코멘트: 목표를 향해 꾸준히 나아가세요! 작은 변화가 큰 결과를 만듭니다.</p>
            </section>

            <section class="weekly-chart-section">
                <h2>주간 건강 점수</h2>
                <div class="chart-container">
                    <canvas id="weeklyHealthChart"></canvas>
                </div>
            </section>

            <section class="weekly-summary-section">
                <h2>주간 요약</h2>
                <ul class="summary-list" id="weekly-summary-list">
                    <!-- 요약 내용은 JS로 동적으로 채울 수 있으나, 초기 구조는 유지 -->
                    <li>
                        <img src="../image/icon_sleep_moon_right.png" alt="수면" class="summary-icon">
                        <span data-summary-type="sleep">지난 주 대비 수면 변화를 분석 중입니다...</span>
                    </li>
                    <li>
                        <img src="../image/icon_meal_bowl_center.png" alt="식사량" class="summary-icon">
                        <span data-summary-type="meal">지난 주 대비 식사량 변화를 분석 중입니다...</span>
                    </li>
                    <li>
                        <img src="../image/icon_exercise_dumbbell_center.png" alt="운동 시간" class="summary-icon">
                        <span data-summary-type="exercise">지난 주 대비 운동 시간 변화를 분석 중입니다...</span>
                    </li>
                    <li>
                        <img src="../image/icon_stress_head_center.png" alt="스트레스 지수" class="summary-icon">
                        <span data-summary-type="stress">지난 주 대비 스트레스 지수 변화를 분석 중입니다...</span>
                    </li>
                    <li>
                        <img src="../image/icon_health_score.png" alt="건강 점수" class="summary-icon"> <!-- icon_health_report.png 등으로 변경 가능 -->
                        <span data-summary-type="overall">지난 주 대비 전체 건강 점수 변화를 분석 중입니다...</span>
                    </li>
                </ul>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loggedInUserEmail = localStorage.getItem('loggedInUserEmail');
    const sidebarProfilePic = document.getElementById('sidebar-profile-pic');
    const sidebarUsername = document.getElementById('sidebar-username');
    const goalInput = document.getElementById('goal-score-input');
    const pointsRemainingSpan = document.getElementById('points-remaining');
    const summaryList = document.getElementById('weekly-summary-list'); // 주간 요약 ul
    
    const defaultProfilePicPath = '../image/user_profile_default.png';
    const defaultGoalScore = 70;

    // --- 유틸리티 함수: 해당 주의 날짜 배열 반환 (월요일 ~ 일요일) ---
    function getWeekDates(date = new Date()) {
        const currentDay = date.getDay(); // 0 (일요일) ~ 6 (토요일)
        const MONDAY = 1; // Date.getDay()는 일요일이 0
        const diff = currentDay === 0 ? -6 : MONDAY - currentDay; // 이번 주 월요일까지의 날짜 차이
        
        const monday = new Date(date);
        monday.setDate(date.getDate() + diff);
        
        const weekDates = [];
        for (let i = 0; i < 7; i++) {
            const day = new Date(monday);
            day.setDate(monday.getDate() + i);
            const year = day.getFullYear();
            const month = String(day.getMonth() + 1).padStart(2, '0');
            const dateNum = String(day.getDate()).padStart(2, '0');
            weekDates.push(`${year}-${month}-${dateNum}`);
        }
        return weekDates;
    }

    // --- 로그인한 사용자 정보 로드 및 사이드바/목표점수 UI 업데이트 ---
    if (loggedInUserEmail) {
        const nickname = localStorage.getItem('userNickname') || 'User';
        const userSpecificProfileKey = 'userProfileImage_' + loggedInUserEmail;
        // localStorage의 userProfileImage는 다른 페이지에서 공용으로 쓰는 현재 로그인 유저의 프로필 사진
        const profilePic = localStorage.getItem(userSpecificProfileKey) || localStorage.getItem('userProfileImage') || defaultProfilePicPath;

        if (sidebarProfilePic) {
            sidebarProfilePic.src = profilePic;
            sidebarProfilePic.alt = nickname + " 프로필";
        }
        if (sidebarUsername) {
            sidebarUsername.textContent = nickname;
        }

        const userGoalScoreKey = 'userGoalScore_' + loggedInUserEmail;
        const storedGoalScore = localStorage.getItem(userGoalScoreKey);
        goalInput.value = storedGoalScore ? parseInt(storedGoalScore) : defaultGoalScore;
    } else {
        // 로그인하지 않은 사용자 처리
        if (sidebarProfilePic) sidebarProfilePic.src = defaultProfilePicPath;
        if (sidebarUsername) sidebarUsername.textContent = 'User';
        goalInput.value = defaultGoalScore;
        // 일부 기능 제한 또는 로그인 페이지로 리디렉션 경고 등
        // 예: document.body.classList.add('機能制限');
    }

    // --- 주간 건강 점수 데이터 (실제로는 이 데이터를 동적으로 가져와야 함) ---
    const labels = ['월', '화', '수', '목', '금', '토', '일'];
    let weeklyScoresForChart = new Array(7).fill(null); // 차트용 데이터 (기본값 null)
    let 이번주기록된점수들 = []; // 평균 계산용 (숫자만)

    if (loggedInUserEmail) {
        const dailyRecordsKey = `dailyRecords_${loggedInUserEmail}`;
        const userDailyRecords = JSON.parse(localStorage.getItem(dailyRecordsKey)) || {};
        const currentWeekDates = getWeekDates(); // 이번 주 날짜들 (YYYY-MM-DD)

        currentWeekDates.forEach((dateKey, index) => {
            if (userDailyRecords[dateKey] && userDailyRecords[dateKey].analysis) {
                const score = userDailyRecords[dateKey].analysis.todayHealthScore;
                if (typeof score === 'number') {
                    weeklyScoresForChart[index] = score;
                    이번주기록된점수들.push(score);
                }
            }
        });
    }

    const averageThisWeekScore = 이번주기록된점수들.length > 0
        ? 이번주기록된점수들.reduce((sum, score) => sum + score, 0) / 이번주기록된점수들.length
        : 0;

    function updatePointsRemaining() {
        const currentGoalScore = parseInt(goalInput.value) || defaultGoalScore;
        goalInput.value = Math.max(1, Math.min(100, currentGoalScore));
        const remaining = Math.max(0, parseInt(goalInput.value) - Math.round(averageThisWeekScore));
        pointsRemainingSpan.textContent = remaining;
    }
    if (loggedInUserEmail) { /* ... (목표 점수 로드) ... */ } else { goalInput.value = defaultGoalScore; }
    goalInput.addEventListener('input', updatePointsRemaining);
    goalInput.addEventListener('change', function() { /* ... (목표 점수 저장) ... */ });
    updatePointsRemaining();

    // --- Chart.js 설정 ---
    const ctx = document.getElementById('weeklyHealthChart');
    if (ctx) {
        new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '주간 건강 점수',
                    data: weeklyScoresForChart,
                    borderColor: '#3377DD',
                    backgroundColor: 'rgba(51, 119, 221, 0.1)',
                    tension: 0.1,
                    fill: true,
                    pointBackgroundColor: '#3377DD',
                    pointBorderColor: '#FFFFFF',
                    pointHoverBackgroundColor: '#FFFFFF',
                    pointHoverBorderColor: '#3377DD',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100, min: 0, ticks: { stepSize: 10, color: '#555', font: { family: "'Noto Sans KR', sans-serif" } }, grid: { color: '#E0E0E0', drawBorder: false, } },
                    x: { ticks: { color: '#555', font: { family: "'Noto Sans KR', sans-serif" } }, grid: { display: true, drawBorder: false } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.7)', titleFont: { family: "'Noto Sans KR', sans-serif", size: 14 },
                        bodyFont: { family: "'Noto Sans KR', sans-serif", size: 12 }, padding: 10, cornerRadius: 6, displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y !== null ? `점수: ${context.parsed.y}` : '기록 없음';
                            }
                        }
                    }
                }
            }
        });
    } else {
        console.error("Error: Canvas element #weeklyHealthChart not found.");
    }

    // --- 주간 요약 업데이트 (샘플 로직, 실제 데이터 기반으로 수정 필요) ---
    function updateWeeklySummary() {
        if (!summaryList || !loggedInUserEmail) return;

        const dailyRecordsKey = `dailyRecords_${loggedInUserEmail}`;
        const userDailyRecords = JSON.parse(localStorage.getItem(dailyRecordsKey)) || {};
        
        // 이번 주 데이터 계산
        const currentWeekDates = getWeekDates();
        const thisWeekData = { sleep: [], meal: [], exercise: [], stress: [], overall: [] };
        currentWeekDates.forEach(dateKey => {
            const record = userDailyRecords[dateKey];
            if (record && record.log && record.analysis) {
                thisWeekData.sleep.push(record.log.sleep_hours);
                thisWeekData.meal.push(record.log.calories);
                thisWeekData.exercise.push(record.log.strength_minutes + record.log.cardio_minutes);
                thisWeekData.stress.push(record.analysis.aiMentalAnalysis.stress_score);
                thisWeekData.overall.push(record.analysis.todayHealthScore);
            }
        });

        const calculateAverage = (arr) => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
        const avgThisWeek = {
            sleep: calculateAverage(thisWeekData.sleep),
            meal: calculateAverage(thisWeekData.meal),
            exercise: calculateAverage(thisWeekData.exercise) / 60, // 시간 단위로
            stress: calculateAverage(thisWeekData.stress),
            overall: calculateAverage(thisWeekData.overall)
        };
        const daysRecordedThisWeek = thisWeekData.overall.length; // 이번 주 기록 일수

        // 지난 주 데이터 로드/계산 (간단화: lastWeekSummary_ 키 사용)
        // 매주 월요일에 이전 주의 데이터를 이 키로 옮기는 로직이 추가로 필요함 (현재는 수동 또는 생략)
        const lastWeekSummaryKey = `lastWeekSummary_${loggedInUserEmail}`;
        const avgLastWeek = JSON.parse(localStorage.getItem(lastWeekSummaryKey)) || {
            sleep: 0, meal: 0, exercise: 0, stress: 0, overall: 0, daysRecorded: 0
        };

        const summaryElements = {
            sleep: { unit: "시간", name: "수면 시간" },
            meal: { unit: "kcal", name: "식사량" },
            exercise: { unit: "시간", name: "운동 시간" },
            stress: { unit: "점", name: "스트레스 지수" },
            overall: { unit: "점", name: "건강 점수" }
        };

        summaryList.querySelectorAll('li span[data-summary-type]').forEach(span => {
            const type = span.dataset.summaryType;
            const currentAvg = avgThisWeek[type];
            const lastAvg = avgLastWeek[type];
            const daysRecordedLastWeek = avgLastWeek.daysRecorded;

            let changeText = "";
            let percentageChange = 0;

            if (daysRecordedLastWeek > 0 && daysRecordedThisWeek > 0) { // 지난 주 기록이 있어야 비교 가능
                if (lastAvg === 0 && currentAvg > 0) { // 지난주 0, 이번주 > 0
                    changeText = `<strong class="highlight-green">새롭게 기록 시작!</strong>`;
                } else if (lastAvg > 0 && currentAvg === 0) { // 지난주 > 0, 이번주 0 (기록 안함)
                        changeText = `기록 없음`;
                } else if (lastAvg === currentAvg) {
                    changeText = `<strong class="highlight-blue">동일</strong>`;
                } else if (lastAvg !== 0) { // 0으로 나누기 방지
                    percentageChange = ((currentAvg - lastAvg) / lastAvg) * 100;
                    if (percentageChange > 0) {
                        changeText = `<strong class="highlight-green">${Math.abs(percentageChange).toFixed(0)}% 증가</strong>`;
                    } else {
                        changeText = `<strong class="highlight-red">${Math.abs(percentageChange).toFixed(0)}% 감소</strong>`;
                    }
                } else { // lastAvg가 0이고 currentAvg도 0일 경우
                        changeText = `기록 없음`;
                }
            } else if (daysRecordedThisWeek > 0) { // 이번 주 기록만 있을 경우
                changeText = "지난 주 기록 없음";
            } else { // 이번 주 기록도 없을 경우
                changeText = "기록 없음";
            }
            
            let baseText = `이번 주 평균 ${summaryElements[type].name}은 <strong class="highlight-blue">${currentAvg.toFixed(1)}${summaryElements[type].unit}</strong>으로 지난 주 대비 ${changeText}합니다.`;
            if (daysRecordedThisWeek > 0) {
                baseText += ` (총 ${daysRecordedThisWeek}일 기록)`;
            }
            if (type === 'stress' && currentAvg > 0) baseText += " (점수가 낮을수록 긍정적입니다.)";
            if (type === 'overall' && percentageChange > 0) baseText += "!";
            
            span.innerHTML = baseText;
        });
    }
    updateWeeklySummary();

    // --- 사이드바 활성 메뉴 설정 ---
    const currentReportPath = "health_report.html";
    const sidebarLinks = document.querySelectorAll('#sidebar-menu li a');
    sidebarLinks.forEach(link => { link.parentElement.classList.remove('active'); });
    const healthReportLinkFromList = Array.from(sidebarLinks).find(a => {
        const linkHref = a.getAttribute('href');
        const iconSrc = a.parentElement.querySelector('.menu-icon') ? a.parentElement.querySelector('.menu-icon').src : '';
        return (linkHref && linkHref.includes(currentReportPath)) ||
                (linkHref === "../Health_Report/health_report.html") ||
                (linkHref === "#" && iconSrc.includes('icon_health_report'));
    });
    if (healthReportLinkFromList) { healthReportLinkFromList.parentElement.classList.add('active');
    } else { document.querySelector('#sidebar-menu li a[href*="health_report.html"]')?.parentElement.classList.add('active'); }

});
</script>
</body>
</html>
